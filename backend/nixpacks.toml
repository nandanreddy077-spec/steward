[phases.setup]
nixPkgs = ["nodejs_20"]

[phases.install]
cmds = [
  "npm install --legacy-peer-deps --include=dev || bun install --no-save",
  "npm run build || (npx tsc || echo 'Build failed, but continuing')"
]

[phases.build]
cmds = [
  "if [ ! -f dist/server.js ]; then npm run build || npx tsc; fi",
  "ls -la dist/ || echo 'dist directory not found'",
  "test -f dist/server.js || (echo 'ERROR: dist/server.js not found after build' && exit 1)"
]

[start]
cmd = "node dist/server.js"

[variables]
NPM_CONFIG_LEGACY_PEER_DEPS = "true"

